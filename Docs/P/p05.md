# C5 : SQL (DDL & DML)

---

## DDL

```sql
DROP TABLE IF EXISTS Fatura;
DROP TABLE IF EXISTS Consumo;
DROP TABLE IF EXISTS Reserva;
DROP TABLE IF EXISTS Menu_Item;
DROP TABLE IF EXISTS Mesa;
DROP TABLE IF EXISTS Cliente;
DROP TABLE IF EXISTS Restaurante;

CREATE TABLE IF NOT EXISTS Restaurante (
    id_restaurante INT PRIMARY KEY AUTO_INCREMENT,
    cidade VARCHAR(50) NOT NULL,
    rua VARCHAR(100) NOT NULL,
    numero VARCHAR(10) NOT NULL,
    codigo_postal VARCHAR(10) NOT NULL
);

CREATE TABLE IF NOT EXISTS Cliente (
    id_cliente INT PRIMARY KEY AUTO_INCREMENT,
    nome VARCHAR(100) NOT NULL,
    contacto VARCHAR(30) NOT NULL
);

CREATE TABLE IF NOT EXISTS Mesa (
    id_mesa INT PRIMARY KEY AUTO_INCREMENT,
    id_restaurante INT NOT NULL,
    numero_mesa INT NOT NULL,
    capacidade INT NOT NULL,
    estado ENUM('Disponível','Pendente','Reservada') NOT NULL DEFAULT 'Disponível',
    CONSTRAINT fk_mesa_restaurante FOREIGN KEY (id_restaurante) REFERENCES Restaurante(id_restaurante),
    CONSTRAINT chk_estado CHECK (estado IN ('Disponível','Pendente','Reservada'))
);

CREATE TABLE IF NOT EXISTS Reserva (
    id_reserva INT PRIMARY KEY AUTO_INCREMENT,
    id_cliente INT NOT NULL,
    id_mesa INT NOT NULL,
    nome_cliente VARCHAR(100) NOT NULL,
    data_hora_reserva DATETIME NOT NULL,
    numero_pessoas INT NOT NULL,
    tipo_menu ENUM('Normal','Aniversário') NOT NULL DEFAULT 'Normal',
    data_criacao DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_reserva_cliente FOREIGN KEY (id_cliente) REFERENCES Cliente(id_cliente),
    CONSTRAINT fk_reserva_mesa FOREIGN KEY (id_mesa) REFERENCES Mesa(id_mesa),
    CONSTRAINT chk_tipo_menu CHECK (tipo_menu IN ('Normal','Aniversário'))
);

CREATE TABLE IF NOT EXISTS Menu_Item (
    id_item INT PRIMARY KEY AUTO_INCREMENT,
    nome VARCHAR(100) NOT NULL,
    descricao TEXT,
    tipo_item ENUM('Entrada','Prato','Bebida','Sobremesa') NOT NULL,
    tipo_menu ENUM('Normal','Aniversário') NOT NULL DEFAULT 'Normal',
    preco_unidade DECIMAL(8,2) NOT NULL,
    CONSTRAINT chk_tipo_item CHECK (tipo_item IN ('Entrada','Prato','Bebida','Sobremesa')),
    CONSTRAINT chk_tipo_menu CHECK (tipo_menu IN ('Normal','Aniversário'))
);

CREATE TABLE IF NOT EXISTS Consumo (
    id_consumo INT PRIMARY KEY AUTO_INCREMENT,
    id_reserva INT NOT NULL,
    nome_item VARCHAR(100) NOT NULL,
    quantidade INT NOT NULL CHECK (quantidade > 0),
    CONSTRAINT fk_consumo_reserva FOREIGN KEY (id_reserva) REFERENCES Reserva(id_reserva)
);

CREATE TABLE IF NOT EXISTS Fatura (
    id_fatura INT PRIMARY KEY AUTO_INCREMENT,
    id_reserva INT NOT NULL,
    data_hora DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    pedidos_resumo TEXT,
    subtotal DECIMAL(10,2) NOT NULL,
    iva DECIMAL(5,2) NOT NULL,
    total_final DECIMAL(10,2) NOT NULL,
    est_pagamento ENUM('Pendente','Pago') NOT NULL DEFAULT 'Pendente',
    CONSTRAINT fk_fatura_reserva FOREIGN KEY (id_reserva) REFERENCES Reserva(id_reserva)
);


```

---

## DML

### Inserts (exemplos)

```sql
INSERT INTO Restaurante (cidade, rua, numero, codigo_postal) VALUES
('Porto', 'Rua das Flores', '123', '4000-123'),
('Lisboa', 'Avenida da Liberdade', '45', '1250-456');

INSERT INTO Cliente (nome, contacto) VALUES
('João Silva', '912345678'),
('Maria Oliveira', '919876543'),
('Carlos Pereira', '913214567');

INSERT INTO Mesa (id_restaurante, numero_mesa, capacidade, estado) VALUES
(1, 1, 4, 'Disponível'),
(1, 2, 2, 'Reservada'),
(2, 1, 6, 'Disponível');

INSERT INTO Reserva (id_cliente, id_mesa, nome_cliente, data_hora_reserva, numero_pessoas, tipo_menu) VALUES
(1, 2, 'João Silva', '2025-06-17 20:00:00', 2, 'Normal'),
(2, 1, 'Maria Oliveira', '2025-06-17 19:30:00', 4, 'Aniversário');

INSERT INTO Menu_Item (nome, descricao, tipo_item, tipo_menu, preco_unidade) VALUES
('Sopa de Legumes', 'Sopa tradicional feita com legumes frescos', 'Entrada', 'Normal', 3.50),
('Bife à Portuguesa', 'Bife com molho tradicional e batatas fritas', 'Prato', 'Normal', 12.00),
('Vinho Tinto', 'Taça de vinho tinto regional', 'Bebida', 'Ambos', 4.50),
('Bolo de Aniversário', 'Bolo especial para celebrações', 'Sobremesa', 'Aniversário', 5.00);

INSERT INTO Consumo (id_reserva, nome_item, quantidade) VALUES
(1, 'Sopa de Legumes', 2),
(1, 'Bife à Portuguesa', 2),
(1, 'Vinho Tinto', 3),
(2, 'Bolo de Aniversário', 1),
(2, 'Vinho Tinto', 4);

INSERT INTO Fatura (id_reserva, pedidos_resumo, subtotal, iva, total_final, est_pagamento) VALUES
(1, '2x Sopa de Legumes, 2x Bife à Portuguesa, 3x Vinho Tinto', 51.50, 10.33, 61.83, 'Pendente'),
(2, '1x Bolo de Aniversário, 4x Vinho Tinto', 23.00, 4.60, 27.60, 'Pago');

```
### Consultas,updates(exemplos)
Ver todas as reservas feitas hoje no restaurante do Porto.
 
```sql
SELECT Reserva.id_reserva, Cliente.nome AS nome_cliente, Reserva.data_hora_reserva
FROM Reserva
JOIN Cliente ON Reserva.id_cliente = Cliente.id_cliente
JOIN Restaurante ON Reserva.id_restaurante = Restaurante.id_restaurante
WHERE Restaurante.cidade = 'Porto'
  AND DATE(Reserva.data_hora_reserva) = CURDATE();
```
Atualizar a morada do restaurante do Porto.
 
```sql
UPDATE Restaurante
SET rua = 'Rua Nova das Flores', numero = '123', codigo_postal = '4000-456'
WHERE cidade = 'Porto';
```
Mostrar as mesas reservadas hoje no restaurante do Porto agrupadas por reserva.
 
```sql
SELECT 
  Reserva.id_reserva, 
  Reserva.data_hora_reserva,
  GROUP_CONCAT(Mesa.numero_mesa ORDER BY Mesa.numero_mesa SEPARATOR ', ') AS mesas_reservadas
FROM Reserva
JOIN Reserva_Mesa ON Reserva.id_reserva = Reserva_Mesa.id_reserva
JOIN Mesa ON Reserva_Mesa.id_mesa = Mesa.id_mesa
JOIN Restaurante ON Mesa.id_restaurante = Restaurante.id_restaurante
WHERE Restaurante.cidade = 'Porto'
  AND DATE(Reserva.data_hora_reserva) = CURDATE()
GROUP BY Reserva.id_reserva, Reserva.data_hora_reserva;
```
---

| [< Previous](rebd04.md) | [^ Main](../../README.md) |
|:----------------------------------:|:----------------------------------:|
